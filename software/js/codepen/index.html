<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monaco Editor + Preview + Console (with Clear Button)</title>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }

    #main-container {
      display: flex;
      flex-direction: row;
      height: 100%;
      width: 100%;
    }

    /* Left panel: editors */
    #editor-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    #tabs {
      display: flex;
      background: #f5f5f5;
      border-bottom: 1px solid #ccc;
    }
    #tabs button {
      flex: 1;
      padding: 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      transition: background 0.2s;
    }
    #tabs button:hover { background: #eee; }
    #tabs button.active {
      background: #fff;
      border-bottom: 2px solid dodgerblue;
    }

    .editor-container {
      flex: 1;
      display: none;
    }
    .editor-container.active {
      display: block;
    }

    /* Right panel: preview + console */
    #right-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    #preview-panel {
      flex: 2;
      position: relative;
    }
    #preview-frame {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }

    /* Console toolbar */
    #console-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2d2d2d;
      color: #ccc;
      font-family: monospace;
      font-size: 13px;
      padding: 4px 8px;
      border-top: 1px solid #444;
      border-bottom: 1px solid #444;
    }
    #console-toolbar button {
      background: #444;
      color: #eee;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 4px;
    }
    #console-toolbar button:hover {
      background: #555;
    }

    #console-panel {
      flex: 1;
      background: #1e1e1e;
      color: #eee;
      font-family: monospace;
      font-size: 13px;
      padding: 8px;
      overflow-y: auto;
    }

    .console-log    { color: #0f0; }
    .console-warn   { color: #ff0; }
    .console-error  { color: #f55; }
    .console-clear  { color: #888; font-style: italic; }

    /* Gutters for Split.js */
    .gutter {
      background-color: #ddd;
      background-repeat: no-repeat;
      background-position: 50%;
    }
    .gutter.gutter-horizontal {
      cursor: col-resize;
      width: 6px;
    }
    .gutter.gutter-vertical {
      cursor: row-resize;
      height: 6px;
    }
  </style>
</head>
<body>
  <div id="main-container">
    <!-- Left: Monaco editors -->
    <div id="editor-panel">
      <div id="tabs">
        <button data-tab="html" class="active">HTML</button>
        <button data-tab="css">CSS</button>
        <button data-tab="js">JavaScript</button>
        <button data-tab="ts">TypeScript</button>
      </div>

      <div id="html-editor" class="editor-container active"></div>
      <div id="css-editor" class="editor-container"></div>
      <div id="js-editor" class="editor-container"></div>
      <div id="ts-editor" class="editor-container"></div>
    </div>

    <!-- Right: Preview + Console -->
    <div id="right-panel">
      <div id="preview-panel">
        <iframe id="preview-frame" sandbox="allow-scripts allow-same-origin"></iframe>
      </div>

      <!-- Console toolbar -->
      <div id="console-toolbar">
        <span>Console</span>
        <button id="clear-console-btn">Clear</button>
      </div>

      <div id="console-panel"></div>
    </div>
  </div>

  <!-- Split.js for resizable panels -->
  <script src="https://cdn.jsdelivr.net/npm/split.js@1.6.5/dist/split.min.js"></script>

  <!-- Monaco Editor Loader -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs/loader.js"></script>

  <script>
    let editors = {};

    // Horizontal split: editor | preview+console
    Split(['#editor-panel', '#right-panel'], {
      sizes: [50, 50],
      minSize: 200,
      gutterSize: 6,
      cursor: 'col-resize'
    });

    // Vertical split inside right panel: preview | console
    Split(['#preview-panel', '#console-toolbar', '#console-panel'], {
      direction: 'vertical',
      sizes: [65, 5, 30],
      minSize: [100, 25, 50],
      gutterSize: 6,
      cursor: 'row-resize'
    });

    // --- Setup Monaco Editors ---
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs' } });
    require(['vs/editor/editor.main'], () => {
      editors.html = monaco.editor.create(document.getElementById('html-editor'), {
        value: "<h1>Hello Monaco!</h1>\n<p>Click Clear Console below ðŸ‘‡</p>",
        language: 'html',
        theme: 'vs-dark',
        automaticLayout: true
      });

      editors.css = monaco.editor.create(document.getElementById('css-editor'), {
        value: "h1 { color: dodgerblue; }",
        language: 'css',
        theme: 'vs-dark',
        automaticLayout: true
      });

      editors.js = monaco.editor.create(document.getElementById('js-editor'), {
        value: "console.log('Hello from JavaScript');",
        language: 'javascript',
        theme: 'vs-dark',
        automaticLayout: true
      });

      editors.ts = monaco.editor.create(document.getElementById('ts-editor'), {
        value: "let msg: string = 'Hello from TypeScript';\nconsole.log(msg);",
        language: 'typescript',
        theme: 'vs-dark',
        automaticLayout: true
      });

      // Tab switching
      document.querySelectorAll('#tabs button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelector('#tabs button.active').classList.remove('active');
          btn.classList.add('active');
          document.querySelector('.editor-container.active').classList.remove('active');
          document.getElementById(btn.dataset.tab + '-editor').classList.add('active');
        });
      });

      // Console handling
      const consolePanel = document.getElementById('console-panel');
      const clearBtn = document.getElementById('clear-console-btn');

      function renderValue(val) {
        // Null / undefined
        if (val === null) return createText('null', '#888');
        if (val === undefined) return createText('undefined', '#888');

        const type = typeof val;

        // Primitives
        if (type === 'string') return createText(`"${val}"`, '#0ff');
        if (type === 'number') return createText(val, '#fd0');
        if (type === 'boolean') return createText(val, '#fd0');
        if (type === 'function') return createText('[Function]', '#fa0');

        // Arrays
        if (Array.isArray(val)) {
          const details = document.createElement('details');
          const summary = document.createElement('summary');
          summary.textContent = `Array(${val.length})`;
          summary.style.color = '#0af';
          details.appendChild(summary);

          const container = document.createElement('div');
          container.style.marginLeft = '1em';

          val.forEach((item, index) => {
            const line = document.createElement('div');
            const keySpan = createText(`${index}: `, '#999');
            line.appendChild(keySpan);
            line.appendChild(renderValue(item));
            container.appendChild(line);
          });

          details.appendChild(container);
          return details;
        }

        // Objects
        if (type === 'object') {
          const keys = Object.keys(val);
          const details = document.createElement('details');
          const summary = document.createElement('summary');
          summary.textContent = `Object { ${keys.length} keys }`;
          summary.style.color = '#0af';
          details.appendChild(summary);

          const container = document.createElement('div');
          container.style.marginLeft = '1em';

          keys.forEach(key => {
            const line = document.createElement('div');
            const keySpan = createText(`${key}: `, '#999');
            line.appendChild(keySpan);
            line.appendChild(renderValue(val[key]));
            container.appendChild(line);
          });

          details.appendChild(container);
          return details;
        }

        // Fallback
        return createText(String(val), '#eee');
      }

      function createText(text, color) {
        const span = document.createElement('span');
        span.style.color = color;
        span.textContent = text;
        return span;
      }

      function addConsoleMessage(type, values) {
        const line = document.createElement('div');
        line.className = 'console-' + type;

        if (Array.isArray(values)) {
          values.forEach((val, i) => {
            if (i > 0) line.appendChild(document.createTextNode(' '));
            line.appendChild(renderValue(val));
          });
        } else {
          line.appendChild(renderValue(values));
        }

        consolePanel.appendChild(line);
        consolePanel.scrollTop = consolePanel.scrollHeight;
      }

      function clearConsole() {
        consolePanel.innerHTML = '';
        const line = document.createElement('div');
        line.className = 'console-clear';
        line.textContent = '--- Console cleared ---';
        consolePanel.appendChild(line);
      }

      clearBtn.addEventListener('click', clearConsole);

      // Build and inject code into iframe
      function updatePreview() {
        clearConsole();
        const html = editors.html.getValue();
        const css = `<style>${editors.css.getValue()}</style>`;
        const js = editors.js.getValue();
        const tsCode = editors.ts.getValue();

        monaco.languages.typescript.getTypeScriptWorker()
          .then(worker => worker(editors.ts.getModel().uri))
          .then(client => client.getEmitOutput(editors.ts.getModel().uri.toString()))
          .then(output => {
            const tsJs = output.outputFiles[0]?.text || "";
            const fullCode = `
              <html>
              <head>${css}</head>
              <body>
                ${html}
                <script>
                  (function() {
                    const send = (type, args) => parent.postMessage({type, args}, '*');
                    console.log = (...args) => send('log', args);
                    console.warn = (...args) => send('warn', args);
                    console.error = (...args) => send('error', args);
                    window.onerror = (msg, src, line, col, err) => {
                      send('error', [msg + ' (' + line + ':' + col + ')']);
                    };
                    try {
                      ${js}
                      ${tsJs}
                    } catch (e) {
                      console.error(e);
                    }
                  })();
                <\/script>
              </body>
              </html>
            `;
            const iframe = document.getElementById('preview-frame');
            iframe.srcdoc = fullCode;
          });
      }

      // Listen for log messages from the iframe
      window.addEventListener('message', (e) => {
        const { type, args } = e.data;
        if (type && args !== undefined) addConsoleMessage(type, args);
      });

      function debounce(fn, delay = 400) {
        let t;
        return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
      }

      const debouncedUpdate = debounce(updatePreview);
      Object.values(editors).forEach(editor => {
        editor.onDidChangeModelContent(debouncedUpdate);
      });

      updatePreview();
    });
  </script>
</body>
</html>
