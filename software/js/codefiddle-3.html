<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeFiddle Tutorial - Part 3</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ CodeFiddle Tutorial</h1>
            <p>Build Your Own Web-Based Code Editor with Live Preview</p>
        </div>

        <div class="card">
            <h2>üìã Part 3</h2>
            <p>In this part we add a console window, so that we can log to it and see any errors.</p>
            
            <div class="feature-grid">
                <div class="feature-item">
                    <h4>üíª Console Window</h4>
                    <p>A developer tool that displays messages like errors, warnings, and logs from a webpage's JavaScript and other code.</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Console Panel (index.html)</h2>
            <p>In this file we need to add the new console panel. So go ahead and replace all of the code in the container</p>
            
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">index.html</span>
                    <button class="copy-btn" onclick="copyCode('html-code')">Copy Code</button>
                </div>
                <pre id="html-code"><code>&lt;div id=&quot;container&quot;&gt;
    &lt;!-- Left: Monaco editors --&gt;
    &lt;div id=&quot;editor-panel&quot;&gt;
        &lt;div id=&quot;tabs&quot;&gt;
        &lt;button data-tab=&quot;html&quot; class=&quot;active&quot;&gt;HTML&lt;/button&gt;
        &lt;button data-tab=&quot;css&quot;&gt;CSS&lt;/button&gt;
        &lt;button data-tab=&quot;js&quot;&gt;JavaScript&lt;/button&gt;
        &lt;button data-tab=&quot;ts&quot;&gt;TypeScript&lt;/button&gt;
        &lt;/div&gt;

        &lt;div id=&quot;html-editor&quot; class=&quot;editor-container active&quot;&gt;&lt;/div&gt;
        &lt;div id=&quot;css-editor&quot; class=&quot;editor-container&quot;&gt;&lt;/div&gt;
        &lt;div id=&quot;js-editor&quot; class=&quot;editor-container&quot;&gt;&lt;/div&gt;
        &lt;div id=&quot;ts-editor&quot; class=&quot;editor-container&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Right: Preview and Console --&gt;
    &lt;div id=&quot;right-panel&quot;&gt;
        &lt;div id=&quot;preview-panel&quot;&gt;
        &lt;iframe id=&quot;preview-frame&quot; sandbox=&quot;allow-scripts allow-same-origin&quot;&gt;&lt;/iframe&gt;
        &lt;/div&gt;
        &lt;div id=&quot;console-panel&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
            </div>

            <h3>What This HTML Does:</h3>
            <ul style="margin-left: 20px; margin-bottom: 20px;">
                <li><strong>Comments:</strong> These help to instantly save us time in the future when trying to see where we are.</li>
                <li><strong>Right Panel:</strong> Now that we are splitting the right hand part of the screen, we need
                to be able to split the screen between code and view, so this will set the seen to allow us to do this.</li>
                <li><strong>Console Panel:</strong> This console logs will appear here.</li>
            </ul>

            <div class="view-live">
              <h4>View Diff</h4>
              <a class="download-btn" href="https://www.diffchecker.com/p8udPnKa/" target="_blank">Open diffchecker</a>
            </div>
        </div>

        <div class="card">
            <h2>CSS Styling Changes (styles.css)</h2>
            <p>We are going to add the style for the new panel, plus put in a split so that the console can be resized.</p>
            
            <p>Open up styles.css and first we will change the container.</p>
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">styles.css</span>
                    <button class="copy-btn" onclick="copyCode('css-code-0')">Copy Code</button>
                </div>

                <pre id="css-code-0"><code>#container {
  display: flex;
  flex-direction: row;
  height: 100vh;
  width: 100%;
}</code></pre>
            </div>

            <p>Let's explain what this is doing:</p>

            <p><code>#container</code> is the root flex layout container.</p>

            <p>It is the parent of both the editor panel (left) and the right panel (preview + console).
            To make Split.js work properly, this container needs to fill the entire visible viewport 
            vertically so that its children can stretch and Split.js can calculate their sizes.</p>

            <p><code>height: 100vh;</code> ensures that the whole coding UI layout fills the entire 
            browser window vertically without relying on the parent elements‚Äô heights, which makes it 
            more stable and easier for Split.js to work inside.</p>

            <p>&nbsp;</p>

            <p>Next change the <code>editor-panel</code></p>
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">styles.css</span>
                    <button class="copy-btn" onclick="copyCode('css-code-5')">Copy Code</button>
                </div>

                <pre id="css-code-5"><code>#editor-panel {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
  min-width: 200px;
  min-height: 0;
}</code></pre>
            </div>

            <p><code>flex</code> and <code>flex-direction</code> mean that within this panel, 
            the children are arranged in a column, top to bottom. Tabs at the top, with editors (stacked)
            at the bottom.</p>

            <p>By default, flex items have <code>min-height: auto</code>, which means they try to stay as 
            tall as their content. This can break layouts where the flex item is supposed to <i>shrink 
            inside a parent</i>, especially when another resizable panel (like Split.js) is involved.</p>
            
            <p>Setting <code>min-height: 0</code> allows this panel to shrink to fit the container, rather 
            than forcing its content height upwards. In other words: it tells the browser ‚Äúit‚Äôs OK to 
            clip or scroll the inside if needed; don‚Äôt force me taller than the container.‚Äù</p>

            <p>&nbsp;</p>

            <p>Now, change the <code>editor-container</code> back to how it originally was</p>
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">styles.css</span>
                    <button class="copy-btn" onclick="copyCode('css-code')">Copy Code</button>
                </div>

                <pre id="css-code"><code>.editor-container {
    flex: 1;
    display: none;
}</code></pre>
            </div>

            <p>Now add the following code after <code>editor-container.active</code></p>
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">styles.css</span>
                    <button class="copy-btn" onclick="copyCode('css-code-1')">Copy Code</button>
                </div>

                <pre id="css-code-1"><code>/* Right panel: preview + console */
#right-panel {
  display: flex;
  flex-direction: column;
  height: 100%;
  flex: 1 1 auto; /* let Split.js / layout manage widths */
  min-height: 0; /* important to allow internal panels to shrink properly */
}

#preview-panel {
  position: relative;
  min-height: 0;
  overflow: hidden; /* prevent children (iframe) from overflowing */
}</code></pre>
            </div>

            <p>So as per the changes to the left panel, in the right-panel, the children
            are arranged top to bottom.</p>
            <p>We also set <code>flex: 1 1 auto;</code> to allow Split.js to manage the 
            widths of the two panels. What this line is really about, is <i>how the right panel behaves horizontally</i>.</p>
            <p>By setting <code>flex: 1 1 auto;</code>, we are saying that the right panel can grow and shrink
            as needed, and that its initial size is based on its content. This allows Split.js to take control of the width,
            and resize it as the user drags the gutter.</p
            <p>And again, we set <code>min-height: 0;</code> to allow the internal panels 
            to shrink properly.</p>
            <p>Finally, we set <code>overflow: hidden;</code> on the preview panel to prevent 
            the iframe from overflowing its container.</p>

            <p>&nbsp;</p>

            <p>The preview-panel uses <code>position: relative;</code> to establish a new positioning context for its child elements.
            This is important because the iframe inside it is set to use 100% of the height and width of it's container.
            By setting <code>position: relative;</code> on the preview-panel, we ensure that the iframe is contained within the 
            preview-panel and can be sized and positioned correctly.</p>

            <p>&nbsp;</p>

            <p>Now let's make a couple of changes to the preview-frame</p>
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">styles.css</span>
                    <button class="copy-btn" onclick="copyCode('css-code-2')">Copy Code</button>
                </div>
                <pre id="css-code-2"><code>#preview-frame {
  display: block; /* avoid inline baseline gaps */
  width: 100%;
  height: 100%;
  border: none;
  background: white;
}</code></pre>
            </div>

            <p>Setting <code>display: block;</code> removes that baseline behavior and makes the iframe 
            behave like a proper <i>block-level box</i>, eliminating the unwanted gap below it.

            <p>We are setting the iframe‚Äôs background to white, because if the iframe content is empty or hasn't loaded yet,
            we want to ensure that the area where the iframe is displayed has a consistent background color.</p>
            
            <p>&nbsp;</p>
            
            <p>Now we can add the style for the console panel, paste this code after the <code>preview-frame</code>.</p>
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">styles.css</span>
                    <button class="copy-btn" onclick="copyCode('css-code-3')">Copy Code</button>
                </div>

                <pre id="css-code-3"><code>#console-panel {
  background: #1e1e1e;
  color: #eee;
  font-family: monospace;
  font-size: 13px;
  padding: 8px;
  overflow-y: auto;
  border-top: 1px solid #444;
  min-height: 0;
  overflow: hidden;
}

.console-log   { color: #0f0; }
.console-error { color: #f55; }
.console-warn  { color: #ff0; }
.console-clear { color: #888; font-style: italic; }</code></pre>
            </div>

            <p>This styles the console panel to look like a typical developer console, with a dark background and light text.
            It also defines different colors for log messages, errors, warnings, and clear messages to help distinguish them visually.</p>
            <p>We set the background to a dark color (#1e1e1e) and the text color to a light color (#eee) to create the high-contrast,
            easy-to-read console area.</p>
            <p>The console panel uses a monospace font to ensure that all characters take up the same amount of horizontal space.
            This is important for displaying code and log messages in a clear and organized manner.</p>
            <p>We set <code>overflow-y: auto;</code> to enable vertical scrolling within the console panel.
            This means that if the content exceeds the visible height of the console panel, a scrollbar will appear,
            allowing users to scroll through the log messages.</p>
            <p>We add a top border to visually separate the console panel from the preview panel above it.</p>
            <p>We set <code>min-height: 0;</code> to allow the console panel to shrink properly within its parent container.</p>
            <p>Finally ee set <code>overflow: hidden;</code> to prevent any content from overflowing the console panel,
            ensuring that it stays contained within its designated area.</p>

            <p>&nbsp;</p>

            <p>In order to ensure that the resizing gutters are clickable, we can add a z-order.
            So add the following code after the <code>console-panel</code> style.</p>
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">styles.css</span>
                    <button class="copy-btn" onclick="copyCode('css-code-3a')">Copy Code</button>
                </div>
                <pre id="css-code-3a"><code>.gutter {
  background-color: #ddd;
  background-repeat: no-repeat;
  background-position: 50%;
  z-index: 1000; /* Ensure gutters are above other elements */
}</code></pre>
            </div>
            <p>What <code>z-index: 1000;</code> does is to set the stacking order of the gutters.
            Elements with a higher z-index value are displayed in front of elements with a lower z-index value.
            By setting a high z-index value for the gutters, we ensure that they are always clickable and interactable,
            even if there are other elements that might overlap them.</p>

            <p>&nbsp;</p>

            <p>Finally, we need to add the style for the vertical resizer. So add the following code at the end of the file</p>
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">styles.css</span>
                    <button class="copy-btn" onclick="copyCode('css-code-4')">Copy Code</button>
                </div>
                <pre id="css-code-4"><code>.gutter.gutter-vertical {
  cursor: row-resize;
  height: 6px;
}</code></pre>
            </div>

            <p>This styles the vertical gutter used for resizing the console panel.</p>
            <p>We set the cursor to <code>row-resize</code> to indicate that the user can click and drag the gutter to resize 
                the panels vertically.</p>
            <p>We set the height of the gutter to 6 pixels to make it easily clickable and draggable.</p>

            <h3>What This CSS Does:</h3>
            <ul style="margin-left: 20px; margin-bottom: 20px;">
                <li><strong>Right Panel:</strong> We set up the right panel to be a flex container with a column layout, allowing the preview and console panels to stack vertically.</li>
                <li><strong>Preview Panel:</strong> We ensure that the preview panel can shrink properly within its parent container and prevent any overflow from its child elements (like the iframe).</li>
                <li><strong>Preview Frame:</strong> We set the iframe to display as a block-level element, ensuring it fills its container without any unwanted gaps.</li>
                <li><strong>Console Panel:</strong> We style the console panel to look like a typical developer console, with a dark background and light text. We also define different colors for log messages, errors, warnings, and clear messages to help distinguish them visually.</li>
                <li><strong>Gutter Z-Index:</strong> We set a high z-index for the gutters to ensure they are always clickable and interactable, even if other elements overlap them.</li>
                <li><strong>Vertical Gutter:</strong> We style the vertical gutter used for resizing the console panel, setting the cursor to indicate it can be dragged and adjusting its height for better usability.</li> 
            </ul>

            <div class="view-live">
              <h4>View Diff</h4>
              <a class="download-btn" href="https://www.diffchecker.com/WJZSVtcn/" target="_blank">Open diffchecker</a>
            </div>
        </div>

        <div class="card">
            <h2>JavaScript Functionality (script.js)</h2>

            <p>Now we need to add the code to make the console work, plus the code to make the resizer work.</p>
            <p>Open up script.js and replace <code>Split(['#editor-panel', '#preview-panel']</code> with the following code:</p>
            
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">script.js</span>
                    <button class="copy-btn" onclick="copyCode('js-code')">Copy Code</button>
                </div>
                <pre id="js-code"><code>Split(['#editor-panel', '#right-panel']</code></pre>
            </div>

            <p>This change allows us to split the entire right panel (which contains both the preview and console panels)
            from the editor panel on the left. This way, when the user drags the gutter, it resizes the entire right panel, 
            allowing both the preview and console panels to adjust their sizes accordingly.</p>

            <p>&nbsp;</p>

            <p>Next, we add the split for the preview and console panels. So add the following code after the existing Split code.</p>
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">script.js</span>
                    <button class="copy-btn" onclick="copyCode('js-code-1')">Copy Code</button>
                </div>
                <pre id="js-code-1"><code>Split(['#preview-panel', '#console-panel'], {
  direction: 'vertical',
  sizes: [70, 30], // Initial sizes: 70% preview, 30% console
  minSize: [100, 50], // Minimum sizes for each panel
  gutterSize: 6,
  cursor: 'row-resize'
});</code></pre>
            </div>
            <p>This code initializes a vertical split between the preview panel and the console panel within the right panel.</p>
            <p>We set the initial sizes to 70% for the preview panel and 30% for the console panel, allowing the preview to take up more space by default.</p>
            <p>We also define minimum sizes for each panel to ensure they don't become too small when resized.</p>
            <p>The gutter size is set to 6 pixels, making it easily clickable and draggable.</p>
            <p>The cursor is set to <code>row-resize</code> to indicate that the user can click and drag the gutter to resize the panels vertically.</p>
            <p>With this setup, users can now resize the preview and console panels independently by dragging the gutter between them.</p>
            <p>&nbsp;</p>
            <p>Before we move on, quickly add a comment block before <code>require.config({ paths</code></p>
            <p>I added <code>// --- Setup Monaco Editors ---</code>.</p>
            <p>This is just to help us find the section quickly in the future.</p>
            <p>&nbsp;</p>
            <p>Next, we need to add the code to make the console work. So add the following code after the <code>Tab switching</code> section.</p>
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">script.js</span>
                    <button class="copy-btn" onclick="copyCode('js-code-2')">Copy Code</button>
                </div>
                <pre id="js-code-2"><code>// Console handling
  const consolePanel = document.getElementById('console-panel');
  function addConsoleMessage(type, message) {
    const line = document.createElement('div');
    line.className = 'console-' + type;
    line.textContent = message;
    consolePanel.appendChild(line);
    consolePanel.scrollTop = consolePanel.scrollHeight;
  }

  function clearConsole() {
    consolePanel.innerHTML = '';
    const line = document.createElement('div');
    line.className = 'console-clear';
    line.textContent = '--- Console cleared ---';
    consolePanel.appendChild(line);
  }</code></pre>
            </div>
            <p>This code sets up the console panel to display log messages, errors, warnings, and clear messages.</p>
            <p>We first get a reference to the console panel element using <code>document.getElementById('console-panel')</code>.</p>
            <p>We define a function <code>addConsoleMessage(type, message)</code> that creates a new div element for each message,
            assigns it a class based on the message type (log, error, warn), sets its text content to the provided message,
            appends it to the console panel, and scrolls the console to the bottom to show the latest message.</p>
            <p>We also define a function <code>clearConsole()</code> that clears all messages from the console panel and adds a "Console cleared" message.</p>
            <p>&nbsp;</p>
            <p>Now find the function <code>updatePreview()</code> and make a call to <code>clearConsole()</code> at the start of the function.</p>
            <p>This ensures that the console is cleared each time the preview is updated, providing a fresh view for new log messages.</p>
            <p>&nbsp;</p>
            <p>Next, we need to override the code in typescript compiler.</p>
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">script.js</span>
                    <button class="copy-btn" onclick="copyCode('js-code-3')">Copy Code</button>
                </div>
                <pre id="js-code-3"><code>// Compile TypeScript to JavaScript using Monaco&#39;s built-in TS compiler
const tsCode = editors.ts.getValue();
monaco.languages.typescript.getTypeScriptWorker()
  .then(worker =&gt; worker(editors.ts.getModel().uri))
  .then(client =&gt; client.getEmitOutput(editors.ts.getModel().uri.toString()))
  .then(output =&gt; {
    const tsJs = output.outputFiles[0]?.text || &quot;&quot;;
    const fullCode = `
      &lt;html&gt;
      &lt;head&gt;${css}&lt;/head&gt;
      &lt;body&gt;
        ${html}
        &lt;script&gt;
          (function() {
            const log = (...args) =&gt; parent.postMessage({type:&#39;log&#39;, msg: args.join(&#39; &#39;)}, &#39;*&#39;);
            const warn = (...args) =&gt; parent.postMessage({type:&#39;warn&#39;, msg: args.join(&#39; &#39;)}, &#39;*&#39;);
            const error = (...args) =&gt; parent.postMessage({type:&#39;error&#39;, msg: args.join(&#39; &#39;)}, &#39;*&#39;);
            console.log = log;
            console.warn = warn;
            console.error = error;
            try {
              ${js}
              ${tsJs}
            } catch (e) {
              console.error(e);
            }
          })();
        &lt;\/script&gt;
      &lt;/body&gt;
      &lt;/html&gt;
    `;
    document.getElementById(&#39;preview-frame&#39;).srcdoc = fullCode;
  });</code></pre>
            </div>
            <p>This code compiles the TypeScript code from the TypeScript editor using Monaco's built-in TypeScript compiler.</p>
            <p>We retrieve the TypeScript code using <code>editors.ts.getValue()</code>.</p>
            <p>We then use Monaco's TypeScript worker to get the compiled JavaScript output.</p>
            <p>Once we have the compiled JavaScript, we construct the full HTML code for the preview iframe,
            embedding the compiled JavaScript along with the HTML, CSS, and JavaScript code from the other editors.</p>
            <p>We also override the default <code>console.log</code>, <code>console.warn</code>, and <code>console.error</code> functions to send messages to
            the parent window (our main application) using <code>postMessage</code>. This allows us to capture console messages from the iframe and display them in our custom console panel.</p>
            <p>Finally, we set the <code>srcdoc</code> of the preview iframe to the constructed HTML code, which updates the live preview.</p>
            
            <p>&nbsp;</p>
            
            <p>Finally, we need to add the code to listen for messages from the iframe and display them in the console panel.
            So add the following code after the function we just changed.</p>
            <div class="file-section">
                <div class="file-header">
                    <span class="filename">script.js</span>
                    <button class="copy-btn" onclick="copyCode('js-code-4')">Copy Code</button>
                </div>
                <pre id="js-code-4"><code>// Listen for log messages from the iframe
  window.addEventListener('message', (e) => {
    const { type, msg } = e.data;
    if (type && msg !== undefined) addConsoleMessage(type, msg);
  });</code></pre>
            </div>
            <p>This code listens for messages sent from the iframe using the <code>postMessage</code> API.</p>
            <p>We add an event listener for the <code>'message'</code> event on the <code>window</code> object.</p>
            <p>When a message is received, we extract the <code>type</code> and <code>msg</code> from the event data.</p>
            <p>Based on the message type (<code>'log'</code>, <code>'warn'</code>, or <code>'error'</code>), we call the 
            <code>addConsoleMessage</code> function to display the message in the console panel.</p>
            <p>This allows us to capture and display console messages from the iframe in our custom console panel.</p>
            
            <h3>What This JavaScript Does:</h3>
            <ul style="margin-left: 20px; margin-bottom: 20px;">
                <li><strong>Vertical Split:</strong> We set up a vertical split between the preview panel and the console panel within the right panel, allowing users to resize them independently.</li>
                <li><strong>Console Handling:</strong> We create functions to add messages to the console panel and to clear the console. This allows us to display log messages, errors, warnings, and clear messages in a structured way.</li>
                <li><strong>Update Preview:</strong> We modify the <code>updatePreview</code> function to clear the console each time the preview is updated, ensuring a fresh view for new log messages.</li>
                <li><strong>TypeScript Compilation:</strong> We compile TypeScript code to JavaScript using Monaco's built-in TypeScript compiler and include the compiled JavaScript in the preview iframe.</li>
                <li><strong>Console Override:</strong> We override the default console methods (<code>log</code>, <code>warn</code>, <code>error</code>) to send messages to the parent window, allowing us to capture console messages from the iframe and display them in our custom console panel.</li>
                <li><strong>Message Listener:</strong> We set up an event listener to listen for messages from the iframe and display them in the console panel, enabling real-time logging of messages from the executed code.</li>
            </ul>

            <div class="view-live">
              <h4>View Diff</h4>
              <a class="download-btn" href="https://www.diffchecker.com/orDr5Txa/" target="_blank">Open diffchecker</a>
            </div>
        </div>

        <div class="card">
            <h2>üöÄ How to Use CodeFiddle</h2>
            <div class="view-live">
              <h4>View Live</h4>
              <a class="download-btn" href="https://publicjoe.github.io/software/js/codefiddle-3/" target="_blank">Open CodeFiddle</a>
            </div>

            <h3>What's New</h3>
            <div class="feature-grid">
                <div class="feature-item">
                    <h4>Console Panel</h4>
                    <p>A console panel has been added below the preview panel to display log messages, errors, and warnings from the executed code.</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>‚¨ÖÔ∏è Previous</h2>
            <ul style="margin-left: 20px;">
                <li><strong>Resizable panels</strong> <a href="codefiddle-2.html">Previous Page</a></li>
            </ul>
        </div>

        <div class="card">
            <h2>‚û°Ô∏è What Next</h2>
            <ul style="margin-left: 20px;">
                <li><strong>Let's add a button to clear the console panel</strong> <a href="codefiddle-4.html">Next Page</a></li>
            </ul>
        </div>
    </div>

    <div id="successMessage" class="success-message">
        ‚úÖ Code copied to clipboard!
    </div>

    <script src="script.js"></script>
</body>
</html>